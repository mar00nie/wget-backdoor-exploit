# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.ssh.username = 'vagrant'
  config.ssh.password = 'vagrant'
  config.ssh.insert_key = 'false'

  config.vm.define :server do |server|
    server.vm.box = "bento/ubuntu-18.04"
    server.vm.box_version = "201812.27.0"
    server.vm.provider "virtualbox" do |vb|
     # Display the VirtualBox GUI when booting the machine
     vb.gui = true
     # Customize the amount of memory on the VM:
     vb.memory = 4096
     # Customize CPU cap
     vb.customize ["modifyvm", :id, "--cpuexecutioncap", "70"]
     # Customize number of CPU
     vb.cpus = 2
     # Customize VM name
     vb.name = "attacker"
    end
    server.vm.network "private_network", ip: "192.168.33.3"
    server.vm.provision "shell", path: "provision/server.sh"
  end

  config.vm.define :client do |client|
    ###############################################################
    # A BOX WITH CAMFLOW INSTALLED
    # AND WGET v1.17
    client.vm.box = "camflow-docker-wget"
    ###############################################################
    #client.vm.box_version = "201812.27.0"
    client.vm.provider "virtualbox" do |vb|
     # Display the VirtualBox GUI when booting the machine
     vb.gui = true
     # Customize the amount of memory on the VM:
     vb.memory = 4096
     # Customize CPU cap
     vb.customize ["modifyvm", :id, "--cpuexecutioncap", "70"]
     # Customize number of CPU
     vb.cpus = 2
     # Customize VM name
     vb.name = "victim"
    end
    client.vm.network "private_network", ip: "192.168.33.8"
    client.vm.provision "shell", inline: <<-SHELL
      # Run Concourse pipeline
      docker-compose up -d
      wget -O /usr/local/bin/fly --user=test --password=test "http://localhost:8080/api/v1/cli?arch=amd64&platform=linux"
      chmod +x /usr/local/bin/fly
      fly --version
      fly --target node-app login -u test -p test --concourse-url http://localhost:8080
      git -C express-status-monitor pull || git clone https://github.com/mar00nie/express-status-monitor.git
      chmod +x express-status-monitor/pipeline.sh
      yes | express-status-monitor/pipeline.sh
    SHELL
  end
end
